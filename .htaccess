# ========================================
# Django Sick Leave Management System
# .htaccess Configuration File
# ========================================

# تفعيل محرك إعادة الكتابة
RewriteEngine On

# ========================================
# إعدادات الأمان (Security Settings)
# ========================================

# منع الوصول للملفات الحساسة
<FilesMatch "\.(py|pyc|pyo|db|sqlite|sqlite3|log|ini|conf|env)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# منع الوصول لمجلدات Django الحساسة
RedirectMatch 403 ^.*/(__pycache__|\.git|\.env|migrations|settings|logs)/.*$

# منع الوصول لملفات النظام
<Files ~ "^\.">
    Order allow,deny
    Deny from all
</Files>

# حماية ملف .htaccess نفسه
<Files .htaccess>
    Order allow,deny
    Deny from all
</Files>

# منع عرض محتويات المجلدات
Options -Indexes

# إخفاء معلومات الخادم
ServerTokens Prod
Header unset Server
Header always unset X-Powered-By

# ========================================
# إعدادات الضغط (Compression)
# ========================================

# تفعيل ضغط GZIP
<IfModule mod_deflate.c>
    # ضغط ملفات النصوص
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
    
    # استثناء الملفات المضغوطة مسبقاً
    SetEnvIfNoCase Request_URI \
        \.(?:gif|jpe?g|png|zip|gz|bz2|sit|rar)$ no-gzip dont-vary
</IfModule>

# ========================================
# إعدادات التخزين المؤقت (Caching)
# ========================================

<IfModule mod_expires.c>
    ExpiresActive On
    
    # ملفات الصور
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/webp "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
    
    # ملفات CSS و JavaScript
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    
    # ملفات الخطوط
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"
    ExpiresByType application/font-woff2 "access plus 1 year"
    
    # ملفات HTML
    ExpiresByType text/html "access plus 1 hour"
    
    # ملفات JSON
    ExpiresByType application/json "access plus 1 hour"
</IfModule>

# إعدادات Cache-Control Headers
<IfModule mod_headers.c>
    # ملفات الوسائط الثابتة
    <FilesMatch "\.(ico|pdf|flv|jpg|jpeg|png|gif|webp|svg|js|css|swf|woff|woff2)$">
        Header set Cache-Control "max-age=2592000, public"
    </FilesMatch>
    
    # ملفات HTML
    <FilesMatch "\.(html|htm)$">
        Header set Cache-Control "max-age=3600, public"
    </FilesMatch>
    
    # إضافة رؤوس الأمان
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
</IfModule>

# ========================================
# إعدادات Django (Django Settings)
# ========================================

# إعادة توجيه جميع الطلبات لـ Django
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/static/
RewriteCond %{REQUEST_URI} !^/media/
RewriteRule ^(.*)$ /index.py/$1 [QSA,L]

# معالجة الملفات الثابتة
RewriteRule ^static/(.*)$ /static/$1 [L]
RewriteRule ^media/(.*)$ /media/$1 [L]

# ========================================
# إعدادات HTTPS و SSL
# ========================================

# إجبار استخدام HTTPS
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# إعدادات HSTS (HTTP Strict Transport Security)
<IfModule mod_headers.c>
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
</IfModule>

# ========================================
# إعدادات الأخطاء المخصصة
# ========================================

ErrorDocument 400 /error/400.html
ErrorDocument 401 /error/401.html
ErrorDocument 403 /error/403.html
ErrorDocument 404 /error/404.html
ErrorDocument 500 /error/500.html
ErrorDocument 502 /error/502.html
ErrorDocument 503 /error/503.html

# ========================================
# إعدادات الأداء (Performance)
# ========================================

# تحسين حجم الذاكرة
php_value memory_limit 256M
php_value max_execution_time 300
php_value max_input_time 300
php_value post_max_size 50M
php_value upload_max_filesize 50M

# تحسين اتصالات قاعدة البيانات
php_value mysql.connect_timeout 60

# ========================================
# إعدادات اللغة والترميز
# ========================================

# تعيين الترميز الافتراضي
AddDefaultCharset UTF-8

# إعدادات اللغة العربية
<IfModule mod_mime.c>
    AddLanguage ar .ar
    AddCharset UTF-8 .ar
</IfModule>

# ========================================
# حماية من الهجمات الشائعة
# ========================================

# منع SQL Injection
RewriteCond %{QUERY_STRING} (\<|%3C).*script.*(\>|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2}) [OR]
RewriteCond %{QUERY_STRING} (\<|%3C).*iframe.*(\>|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} (\<|%3C).*object.*(\>|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} (\<|%3C).*embed.*(\>|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} (SELECT|UNION|INSERT|DROP|DELETE|UPDATE|CREATE|ALTER) [NC]
RewriteRule ^(.*)$ - [F,L]

# منع User Agent المشبوه
RewriteCond %{HTTP_USER_AGENT} ^$ [OR]
RewriteCond %{HTTP_USER_AGENT} ^(-|\.|') [OR]
RewriteCond %{HTTP_USER_AGENT} ^(.*)(<|>|%0A|%0D|%27|%3C|%3E|%00|0x00) [NC,OR]
RewriteCond %{HTTP_USER_AGENT} (libwww-perl|wget|python|nikto|curl|scan|java|winhttp|clshttp|loader) [NC,OR]
RewriteCond %{HTTP_USER_AGENT} (%0A|%0D|%27|%3C|%3E|%00) [NC,OR]
RewriteCond %{HTTP_USER_AGENT} (;|<|>|'|"|\)|\(|%0A|%0D|%22|%27|%28|%3C|%3E|%00).*(libwww-perl|wget|python|nikto|curl|scan|java|winhttp|HTTrack|clshttp|archiver|loader|email|harvest|extract|grab|miner) [NC]
RewriteRule .* - [F,L]

# حد معدل الطلبات (Rate Limiting)
<IfModule mod_evasive24.c>
    DOSHashTableSize    2048
    DOSPageCount        10
    DOSSiteCount        50
    DOSPageInterval     1
    DOSSiteInterval     1
    DOSBlockingPeriod   600
</IfModule>

# ========================================
# إعدادات إضافية للتحسين
# ========================================

# تحسين اتصالات Keep-Alive
<IfModule mod_headers.c>
    Header set Connection keep-alive
</IfModule>

# تحسين ETags
<IfModule mod_headers.c>
    Header unset ETag
</IfModule>
FileETag None

# تحسين Vary Header
<IfModule mod_headers.c>
    <FilesMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg)$">
        Header set Vary "Accept-Encoding"
    </FilesMatch>
</IfModule>
