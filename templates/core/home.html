{% extends 'base.html' %}

{% block title %}الصفحة الرئيسية - نظام إدارة الإجازات المرضية{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2>لوحة التحكم</h2>
        <p class="text-muted">مرحباً بك في نظام إدارة الإجازات المرضية</p>
    </div>
</div>

<!-- إحصائيات عامة -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
        <div class="card text-white bg-primary h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="card-title mb-2">الإجازات المرضية</h6>
                        <h3 class="mb-0 responsive-text">{{ stats.sick_leaves_count }}</h3>
                    </div>
                    <div class="ms-3">
                        <i class="fas fa-procedures fa-2x d-none d-md-block"></i>
                        <i class="fas fa-procedures fa-lg d-md-none"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
        <div class="card text-white bg-success h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="card-title mb-2">إجازات المرافقين</h6>
                        <h3 class="mb-0 responsive-text">{{ stats.companion_leaves_count }}</h3>
                    </div>
                    <div class="ms-3">
                        <i class="fas fa-user-nurse fa-2x d-none d-md-block"></i>
                        <i class="fas fa-user-nurse fa-lg d-md-none"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
        <div class="card text-white bg-info h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="card-title mb-2">الفواتير</h6>
                        <h3 class="mb-0 responsive-text">{{ stats.invoices_count }}</h3>
                    </div>
                    <div class="ms-3">
                        <i class="fas fa-file-invoice-dollar fa-2x d-none d-md-block"></i>
                        <i class="fas fa-file-invoice-dollar fa-lg d-md-none"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
        <div class="card text-white bg-warning h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="card-title mb-2">المدفوعات</h6>
                        <h3 class="mb-0 responsive-text">{{ stats.payments_count }}</h3>
                    </div>
                    <div class="ms-3">
                        <i class="fas fa-money-bill-wave fa-2x d-none d-md-block"></i>
                        <i class="fas fa-money-bill-wave fa-lg d-md-none"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- إحصائيات مالية -->
<div class="row mb-4">
    <div class="col-lg-4 col-md-6 mb-3">
        <div class="card text-white bg-dark h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="card-title mb-2">إجمالي الفواتير</h6>
                        <h4 class="mb-0 responsive-text">{{ stats.total_invoices_amount|floatformat:2 }} ريال</h4>
                    </div>
                    <div class="ms-3">
                        <i class="fas fa-file-invoice fa-2x d-none d-md-block"></i>
                        <i class="fas fa-file-invoice fa-lg d-md-none"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4 col-md-6 mb-3">
        <div class="card text-white bg-dark h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="card-title mb-2">إجمالي المدفوعات</h6>
                        <h4 class="mb-0 responsive-text">{{ stats.total_payments_amount|floatformat:2 }} ريال</h4>
                    </div>
                    <div class="ms-3">
                        <i class="fas fa-hand-holding-usd fa-2x d-none d-md-block"></i>
                        <i class="fas fa-hand-holding-usd fa-lg d-md-none"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4 col-md-12 mb-3">
        <div class="card text-white {% if stats.total_balance > 0 %}bg-danger{% else %}bg-success{% endif %} h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="card-title mb-2">الرصيد المتبقي</h6>
                        <h4 class="mb-0 responsive-text">{{ stats.total_balance|floatformat:2 }} ريال</h4>
                    </div>
                    <div class="ms-3">
                        <i class="fas fa-balance-scale fa-2x d-none d-md-block"></i>
                        <i class="fas fa-balance-scale fa-lg d-md-none"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- إحصائيات إضافية -->
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card text-white bg-secondary">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title">الأطباء</h5>
                        <h2 class="mb-0">{{ stats.doctors_count }}</h2>
                    </div>
                    <i class="fas fa-user-md fa-3x"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-3">
        <div class="card text-white bg-secondary">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title">المرضى</h5>
                        <h2 class="mb-0">{{ stats.patients_count }}</h2>
                    </div>
                    <i class="fas fa-user-injured fa-3x"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-3">
        <div class="card text-white bg-secondary">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title">العملاء</h5>
                        <h2 class="mb-0">{{ stats.clients_count }}</h2>
                    </div>
                    <i class="fas fa-users fa-3x"></i>
                </div>
            </div>
        </div>
    </div>
</div>

{% if request.user.is_doctor and stats.doctor_sick_leaves_count is not None %}
<!-- إحصائيات خاصة بالطبيب -->
<div class="row mb-4">
    <div class="col-12">
        <h4>إحصائيات خاصة بك</h4>
    </div>
    <div class="col-md-6 mb-3">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title">الإجازات المرضية الخاصة بك</h5>
                        <h2 class="mb-0">{{ stats.doctor_sick_leaves_count }}</h2>
                    </div>
                    <i class="fas fa-procedures fa-3x"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title">إجازات المرافقين الخاصة بك</h5>
                        <h2 class="mb-0">{{ stats.doctor_companion_leaves_count }}</h2>
                    </div>
                    <i class="fas fa-user-nurse fa-3x"></i>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="row">
    <!-- آخر الإجازات المرضية -->
    <div class="col-xl-6 col-lg-12 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center">
                <h5 class="mb-2 mb-sm-0">آخر الإجازات المرضية</h5>
                <a href="{% url 'core:sick_leave_list' %}" class="btn btn-sm btn-primary">عرض الكل</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="text-nowrap">رقم الإجازة</th>
                                <th class="text-nowrap d-none d-md-table-cell">المريض</th>
                                <th class="text-nowrap d-none d-lg-table-cell">تاريخ البداية</th>
                                <th class="text-nowrap d-none d-lg-table-cell">تاريخ النهاية</th>
                                <th class="text-nowrap">الحالة</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for leave in recent_sick_leaves %}
                            <tr>
                                <td class="text-nowrap">{{ leave.leave_id }}</td>
                                <td class="d-none d-md-table-cell">
                                    <span class="text-truncate d-inline-block" style="max-width: 120px;" title="{{ leave.patient.name }}">
                                        {{ leave.patient.name }}
                                    </span>
                                </td>
                                <td class="d-none d-lg-table-cell text-nowrap">{{ leave.start_date }}</td>
                                <td class="d-none d-lg-table-cell text-nowrap">{{ leave.end_date }}</td>
                                <td>
                                    {% if leave.status == 'active' %}
                                    <span class="badge bg-success">نشطة</span>
                                    {% elif leave.status == 'cancelled' %}
                                    <span class="badge bg-danger">ملغية</span>
                                    {% elif leave.status == 'expired' %}
                                    <span class="badge bg-secondary">منتهية</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <!-- عرض تفاصيل إضافية للأجهزة المحمولة -->
                            <tr class="d-md-none">
                                <td colspan="2" class="border-top-0 pt-0 pb-2">
                                    <small class="text-muted">
                                        المريض: {{ leave.patient.name }}<br>
                                        من {{ leave.start_date }} إلى {{ leave.end_date }}
                                    </small>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-4">لا توجد إجازات مرضية</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- آخر إجازات المرافقين -->
    <div class="col-xl-6 col-lg-12 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center">
                <h5 class="mb-2 mb-sm-0">آخر إجازات المرافقين</h5>
                <a href="{% url 'core:companion_leave_list' %}" class="btn btn-sm btn-primary">عرض الكل</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="text-nowrap">رقم الإجازة</th>
                                <th class="text-nowrap d-none d-md-table-cell">المريض</th>
                                <th class="text-nowrap d-none d-lg-table-cell">المرافق</th>
                                <th class="text-nowrap d-none d-lg-table-cell">تاريخ البداية</th>
                                <th class="text-nowrap">الحالة</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for leave in recent_companion_leaves %}
                            <tr>
                                <td class="text-nowrap">{{ leave.leave_id }}</td>
                                <td class="d-none d-md-table-cell">
                                    <span class="text-truncate d-inline-block" style="max-width: 120px;" title="{{ leave.patient.name }}">
                                        {{ leave.patient.name }}
                                    </span>
                                </td>
                                <td class="d-none d-lg-table-cell">
                                    <span class="text-truncate d-inline-block" style="max-width: 120px;" title="{{ leave.companion.name }}">
                                        {{ leave.companion.name }}
                                    </span>
                                </td>
                                <td class="d-none d-lg-table-cell text-nowrap">{{ leave.start_date }}</td>
                                <td>
                                    {% if leave.status == 'active' %}
                                    <span class="badge bg-success">نشطة</span>
                                    {% elif leave.status == 'cancelled' %}
                                    <span class="badge bg-danger">ملغية</span>
                                    {% elif leave.status == 'expired' %}
                                    <span class="badge bg-secondary">منتهية</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <!-- عرض تفاصيل إضافية للأجهزة المحمولة -->
                            <tr class="d-md-none">
                                <td colspan="2" class="border-top-0 pt-0 pb-2">
                                    <small class="text-muted">
                                        المريض: {{ leave.patient.name }}<br>
                                        المرافق: {{ leave.companion.name }}<br>
                                        التاريخ: {{ leave.start_date }}
                                    </small>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-4">لا توجد إجازات مرافقين</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- آخر الفواتير -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">آخر الفواتير</h5>
                <a href="{% url 'core:leave_invoice_list' %}" class="btn btn-sm btn-primary">عرض الكل</a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>رقم الفاتورة</th>
                                <th>العميل</th>
                                <th>المبلغ</th>
                                <th>تاريخ الإصدار</th>
                                <th>الحالة</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for invoice in recent_invoices %}
                            <tr>
                                <td>{{ invoice.invoice_number }}</td>
                                <td>{{ invoice.client.name }}</td>
                                <td>{{ invoice.amount }} ريال</td>
                                <td>{{ invoice.issue_date }}</td>
                                <td>
                                    {% if invoice.status == 'unpaid' %}
                                    <span class="badge bg-danger">غير مدفوعة</span>
                                    {% elif invoice.status == 'partially_paid' %}
                                    <span class="badge bg-warning">مدفوعة جزئيًا</span>
                                    {% elif invoice.status == 'paid' %}
                                    <span class="badge bg-success">مدفوعة بالكامل</span>
                                    {% elif invoice.status == 'cancelled' %}
                                    <span class="badge bg-secondary">ملغية</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center">لا توجد فواتير</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- آخر المدفوعات -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">آخر المدفوعات</h5>
                <a href="{% url 'core:payment_list' %}" class="btn btn-sm btn-primary">عرض الكل</a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>رقم الدفعة</th>
                                <th>العميل</th>
                                <th>المبلغ</th>
                                <th>تاريخ الدفع</th>
                                <th>طريقة الدفع</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in recent_payments %}
                            <tr>
                                <td>{{ payment.payment_number }}</td>
                                <td>{{ payment.client.name }}</td>
                                <td>{{ payment.amount }} ريال</td>
                                <td>{{ payment.payment_date }}</td>
                                <td>
                                    {% if payment.payment_method == 'cash' %}
                                    <span class="badge bg-success">نقدًا</span>
                                    {% elif payment.payment_method == 'bank_transfer' %}
                                    <span class="badge bg-primary">تحويل بنكي</span>
                                    {% elif payment.payment_method == 'check' %}
                                    <span class="badge bg-info">شيك</span>
                                    {% elif payment.payment_method == 'credit_card' %}
                                    <span class="badge bg-warning">بطاقة ائتمان</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center">لا توجد مدفوعات</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
