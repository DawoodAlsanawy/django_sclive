{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}تعديل الإجازة المرضية - نظام إدارة الإجازات المرضية{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .select2-container--default .select2-selection--single {
        height: 38px;
        border: 1px solid #ced4da;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 38px;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 36px;
    }
</style>
{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/moment-hijri@2.1.2/moment-hijri.min.js"></script>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2>تعديل الإجازة المرضية</h2>
        <p class="text-muted">تعديل بيانات الإجازة المرضية رقم {{ sick_leave.leave_id }}</p>
    </div>
</div>

<!-- Modal إضافة مريض جديد -->
<div class="modal fade" id="patientModal" tabindex="-1" aria-labelledby="patientModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="patientModalLabel">إضافة مريض جديد</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        {{ form.new_patient_national_id|as_crispy_field }}
                    </div>
                    <div class="col-md-6">
                        {{ form.new_patient_name|as_crispy_field }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        {{ form.new_patient_name_en|as_crispy_field }}
                    </div>
                    <div class="col-md-6">
                        {{ form.new_patient_phone|as_crispy_field }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        {{ form.new_patient_nationality|as_crispy_field }}
                    </div>
                    <div class="col-md-6">
                        {{ form.new_patient_nationality_en|as_crispy_field }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        {{ form.new_patient_employer_name|as_crispy_field }}
                    </div>
                    <div class="col-md-6">
                        {{ form.new_patient_employer_name_en|as_crispy_field }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        {{ form.new_patient_address|as_crispy_field }}
                    </div>
                    <div class="col-md-6">
                        {{ form.new_patient_address_en|as_crispy_field }}
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-primary save-patient-btn">حفظ</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal تعديل بيانات المريض -->
<div class="modal fade" id="editPatientModal" tabindex="-1" aria-labelledby="editPatientModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPatientModalLabel">تعديل بيانات المريض</h5>
                <a type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" href="{%url 'core:patient_edit' form.patient.value  %}"></a>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit_patient_id">
                <!-- هنا سيتم تحميل بيانات المريض -->
                <div id="edit-patient-form-container">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">جاري التحميل...</span>
                        </div>
                        <p class="mt-2">جاري تحميل بيانات المريض...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-primary update-patient-btn">تحديث</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal إضافة طبيب جديد -->
<div class="modal fade" id="doctorModal" tabindex="-1" aria-labelledby="doctorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="doctorModalLabel">إضافة طبيب جديد</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        {{ form.new_doctor_national_id|as_crispy_field }}
                    </div>
                    <div class="col-md-6">
                        {{ form.new_doctor_name|as_crispy_field }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        {{ form.new_doctor_name_en|as_crispy_field }}
                    </div>
                    <div class="col-md-6">
                        {{ form.new_doctor_phone|as_crispy_field }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        {{ form.new_doctor_position|as_crispy_field }}
                    </div>
                    <div class="col-md-6">
                        {{ form.new_doctor_position_en|as_crispy_field }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        {{ form.new_doctor_hospital|as_crispy_field }}
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-primary save-doctor-btn">حفظ</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal تعديل بيانات الطبيب -->
<div class="modal fade" id="editDoctorModal" tabindex="-1" aria-labelledby="editDoctorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editDoctorModalLabel">تعديل بيانات الطبيب</h5>
                <a type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" href="{%url 'core:doctor_edit'  form.doctor.value %}"></a>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit_doctor_id">
                <!-- هنا سيتم تحميل بيانات الطبيب -->
                <div id="edit-doctor-form-container">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">جاري التحميل...</span>
                        </div>
                        <p class="mt-2">جاري تحميل بيانات الطبيب...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-primary update-doctor-btn">تحديث</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal إضافة مستشفى جديد -->
<div class="modal fade" id="hospitalModal" tabindex="-1" aria-labelledby="hospitalModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="hospitalModalLabel">إضافة مستشفى جديد</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        {{ form.new_hospital_name|as_crispy_field }}
                    </div>
                    <div class="col-md-6">
                        {{ form.new_hospital_name_en|as_crispy_field }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        {{ form.new_hospital_address|as_crispy_field }}
                    </div>
                    <div class="col-md-6">
                        {{ form.new_hospital_address_en|as_crispy_field }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">معلومات الاتصال</label>
                            <input type="text" class="form-control" id="id_new_hospital_contact_info" placeholder="أدخل معلومات الاتصال">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">شعار المستشفى</label>
                            <input type="file" class="form-control" id="id_new_hospital_logo" accept="image/*">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-primary save-hospital-btn">حفظ</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal تعديل بيانات المستشفى -->
<div class="modal fade" id="editHospitalModal" tabindex="-1" aria-labelledby="editHospitalModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editHospitalModalLabel">تعديل بيانات المستشفى</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit_hospital_id">
                <!-- هنا سيتم تحميل بيانات المستشفى -->
                <div id="edit-hospital-form-container">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">جاري التحميل...</span>
                        </div>
                        <p class="mt-2">جاري تحميل بيانات المستشفى...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-primary update-hospital-btn">تحديث</button>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <form method="post" id="sick-leave-form">
            {% csrf_token %}

            <div class="row">
                <div class="col-md-3">
                    {{ form.prefix|as_crispy_field }}
                </div>
                <div class="col-md-3">
                    {{ form.leave_id|as_crispy_field }}
                </div>
                <div class="col-md-3">
                    {{ form.issue_date|as_crispy_field }}
                </div>
                <div class="col-md-3">
                    {{ form.created_date|as_crispy_field }}
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    {{ form.patient|as_crispy_field }}
                    <div class="mt-2 d-flex gap-2">
                        <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#patientModal">
                            <i class="fas fa-plus-circle"></i> إضافة مريض جديد
                        </button>

                        <a type="button" class="btn btn-sm btn-outline-warning edit-patient-btn" href="{% url 'core:patient_edit' form.patient.value %}" >
                            <i class="fas fa-edit"></i> تعديل بيانات المريض
                        </a>
                    </div>
                </div>
                <div class="col-md-6">
                    {{ form.doctor|as_crispy_field }}
                    <div class="mt-2 d-flex gap-2">
                        <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#doctorModal">
                            <i class="fas fa-plus-circle"></i> إضافة طبيب جديد
                        </button>
                        <a type="button" class="btn btn-sm btn-outline-warning edit-doctor-btn" href="{%url 'core:doctor_edit'  form.doctor.value %}">
                            <i class="fas fa-edit"></i> تعديل بيانات الطبيب
                        </a>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    
                    {{ form.hospital|as_crispy_field }}
                    
                    
                    <div class="mt-2 d-flex gap-2">
                        <button type="button" class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#hospitalModal">
                            <i class="fas fa-plus-circle"></i> إضافة مستشفى جديد
                        </button>
                        {%if form.hospital.value%}
                        <a type="button" class="btn btn-sm btn-outline-warning edit-hospital-btn" href="{%url 'core:hospital_edit'  form.hospital.value %}">
                            <i class="fas fa-edit"></i> تعديل بيانات المستشفى
                        </a>
                        {%else%}
                        <a type="button" class="btn btn-sm btn-outline-warning edit-hospital-btn" href="#">
                            <i class="fas fa-edit"></i> تعديل بيانات المستشفى
                        </a>
                        {%endif%}
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-3">
                    {{ form.admission_date|as_crispy_field }}
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="admission_date_hijri">تاريخ الدخول (هجري)</label>
                        <input type="text" id="admission_date_hijri" class="form-control" value="{{form.admission_date_hijri.value}}" />
                    </div>
                </div>
                <div class="col-md-3">
                    {{ form.discharge_date|as_crispy_field }}
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="discharge_date_hijri">تاريخ الخروج (هجري)</label>
                        <input type="text" id="discharge_date_hijri" class="form-control" value="{{form.discharge_date_hijri.value}}" >
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-3">
                    {{ form.start_date|as_crispy_field }}
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        {% comment %} <label for="start_date_hijri">تاريخ البداية (هجري)</label> {% endcomment %}
                        <input type="hidden" id="start_date_hijri" class="form-control" readonly>
                    </div>
                </div>
                <div class="col-md-3">
                    {{ form.end_date|as_crispy_field }}
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        {% comment %} <label for="end_date_hijri">تاريخ النهاية (هجري)</label> {% endcomment %}
                        <input type="hidden" id="end_date_hijri" class="form-control" readonly>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    {{ form.status|as_crispy_field }}
                </div>
                <div class="col-md-6">
                    {{ form.duration_days|as_crispy_field }}
                    <small class="form-text text-muted">
                        يمكنك تعديل المدة يدوياً أو تركها ليتم حسابها تلقائيًا بناءً على تاريخ البداية والنهاية.
                        إذا كان تاريخ البداية والنهاية في نفس اليوم، فالإجازة تعتبر ليوم واحد.
                        إذا كان تاريخ النهاية بعد تاريخ البداية بيوم واحد، فالإجازة تعتبر ليومين.
                    </small>
                </div>
                <div class="col-md-6">
                    {{ form.duration_days2|as_crispy_field }}
                    <small class="form-text text-muted">
                        يمكنك تعديل المدة يدوياً أو تركها ليتم حسابها تلقائيًا بناءً على تاريخ البداية والنهاية.
                        إذا كان تاريخ البداية والنهاية في نفس اليوم، فالإجازة تعتبر ليوم واحد.
                        إذا كان تاريخ النهاية بعد تاريخ البداية بيوم واحد، فالإجازة تعتبر ليومين.
                    </small>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    {{ form.client|as_crispy_field }}
                </div>
            </div>

            <div class="mt-4">
                <button type="submit" class="btn btn-primary">حفظ التغييرات</button>
                <a href="{% url 'core:sick_leave_detail' sick_leave.id %}" class="btn btn-secondary">إلغاء</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function() {


         // تعيين معالجات الأحداث لنسخ التواريخ
         $('#id_admission_date').on('change', function() {
            $('#id_start_date').val($(this).val());
            calculateDaysDifference();
        });
        
        $('#id_discharge_date').on('change', function() {
            $('#id_end_date').val($(this).val());
            calculateDaysDifference();
        });
    
        // دالة مشتركة لحساب الفرق بين التاريخين
        function calculateDaysDifference() {
            // الحصول على قيم التواريخ
            var startDateStr = $('#id_start_date').val();
            var endDateStr = $('#id_end_date').val();
            
            // التحقق من وجود القيم
            if (!startDateStr || !endDateStr) {
                $('#id_duration_days2').val('');
                return;
            }
            
            var startDate = new Date(startDateStr);
            var endDate = new Date(endDateStr);
            
            // التحقق من أن تاريخ النهاية بعد تاريخ البداية
            
            
            // حساب الفرق بين التاريخين بالأيام (بما في ذلك اليوم الأخير)
            var timeDiff = endDate.getTime() - startDate.getTime();
            var dayDiff = Math.floor(timeDiff / (1000 * 3600 * 24)) + 1;
            
            // عرض النتيجة
            $('#id_duration_days2').val(dayDiff);
        }
        
        // تعيين معالجات الأحداث لحساب الفرق عند تغيير أي من التاريخين
        $('#id_start_date, #id_end_date').on('change', calculateDaysDifference);
        
        // حساب الفرق عند تحميل الصفحة إذا كانت الحقول تحتوي على قيم
        calculateDaysDifference();
        // إعداد URLs للـ AJAX
        var ajaxUrls = {
            getPatientData: "/patients/",
            getDoctorData: "/doctors/",
            getHospitalData: "/hospitals/",
            getCompanionData: "/companions/",
            updatePatientData: "/patients/",
            updateDoctorData: "/doctors/",
            updateHospitalData: "/hospitals/",
            updateCompanionData: "/companions/"
        };

        // تفعيل Select2 للمريض والطبيب
        $('#id_patient').select2({
            placeholder: 'اختر المريض',
            allowClear: true
        });

        $('#id_doctor').select2({
            placeholder: 'اختر الطبيب',
            allowClear: true
        });
        

        // تحويل التواريخ إلى هجري
        function convertToHijri() {
            var startDate = $('#id_start_date').val();
            var endDate = $('#id_end_date').val();
            var admissionDate = $('#id_admission_date').val();
            var dischargeDate = $('#id_discharge_date').val();

            // تحويل التواريخ إلى هجري
            if (startDate) {
                var hijriStartDate = moment(startDate, 'YYYY-MM-DD').format('iYYYY/iMM/iDD');
                $('#start_date_hijri').val(hijriStartDate);
            }

            if (endDate) {
                var hijriEndDate = moment(endDate, 'YYYY-MM-DD').format('iYYYY/iMM/iDD');
                $('#end_date_hijri').val(hijriEndDate);
            }

            if (admissionDate) {
                var hijriAdmissionDate = moment(admissionDate, 'YYYY-MM-DD').format('iYYYY/iMM/iDD');
                $('#admission_date_hijri').val(hijriAdmissionDate);
            }

            if (dischargeDate) {
                var hijriDischargeDate = moment(dischargeDate, 'YYYY-MM-DD').format('iYYYY/iMM/iDD');
                $('#discharge_date_hijri').val(hijriDischargeDate);
            }
        }

        // حساب المدة تلقائيًا
        function calculateDuration() {
            var startDate = $('#id_start_date').val();
            var endDate = $('#id_end_date').val();

            if (startDate && endDate) {
                var start = new Date(startDate);
                var end = new Date(endDate);
                var diffTime = Math.abs(end - start);
                var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                // +1 لأن اليوم الأخير محسوب
                // إذا كان تاريخ البداية والنهاية في نفس اليوم، فالإجازة تعتبر ليوم واحد
                // إذا كان تاريخ النهاية بعد تاريخ البداية بيوم واحد، فالإجازة تعتبر ليومين
                // وهكذا، كل فرق بين التاريخين يضيف يومًا إضافيًا للإجازة

                $('#id_duration_days').val(diffDays);
            }
        }

        // إظهار/إخفاء حقول إضافة مريض جديد
        $('#id_patient').change(function() {
            if ($(this).val() === '') {
                $('.new-patient-fields').slideDown();
            } else {
                $('.new-patient-fields').slideUp();
            }
        });

        // إظهار/إخفاء حقول إضافة طبيب جديد
        $('#id_doctor').change(function() {
            if ($(this).val() === '') {
                $('.new-doctor-fields').slideDown();
            } else {
                $('.new-doctor-fields').slideUp();
            }
        });

        // إظهار/إخفاء حقول إضافة مستشفى جديد
        $('#id_new_doctor_hospital').change(function() {
            if ($(this).val() === '') {
                $('.new-hospital-fields').slideDown();
            } else {
                $('.new-hospital-fields').slideUp();
            }
        });

        // تفعيل Select2 لحقل المستشفى
        $('#id_hospital').select2({
            placeholder: 'اختر المستشفى',
            allowClear: true
        });

        // تفعيل التواريخ
        $('#id_start_date, #id_end_date, #id_admission_date, #id_discharge_date').datepicker({
            format: 'yyyy-mm-dd',
            autoclose: true,
            todayHighlight: true
        }).on('changeDate', function() {
            // تحديث التواريخ الهجرية عند تغيير التاريخ الميلادي
            convertToHijri();
        });

        // تحديث التواريخ الهجرية عند تحميل الصفحة
        convertToHijri();

        // تعطيل الحساب التلقائي للمدة عند تغيير التواريخ
        $('#id_start_date, #id_end_date').off('change');

        // إضافة زر لحساب المدة
        $('#id_duration_days').after('<button type="button" class="btn btn-sm btn-outline-secondary mt-2 ms-2" id="calculate-duration-btn">حساب المدة تلقائيًا</button>');

        // تفعيل زر حساب المدة
        $('#calculate-duration-btn').click(function(e) {
            e.preventDefault();
            calculateDuration();
        });

        // التحقق من القيم الأولية
        if ($('#id_patient').val() === '') {
            $('.new-patient-fields').show();
        }

        if ($('#id_doctor').val() === '') {
            $('.new-doctor-fields').show();
        }

        if ($('#id_new_doctor_hospital').val() === '') {
            $('.new-hospital-fields').show();
        }

        // تفعيل أزرار تعديل البيانات - الانتقال المباشر لصفحات التعديل
        $('.edit-patient-btn').click(function() {
            var patientId = $('#id_patient').val();
            if (patientId) {
                // الانتقال إلى صفحة تعديل المريض
                window.open('/patients/' + patientId + '/edit/', '_blank');
            } else {
                alert('الرجاء اختيار مريض أولاً');
                return false;
            }
        });

        $('.edit-doctor-btn').click(function() {
            var doctorId = $('#id_doctor').val();
            if (doctorId) {
                // الانتقال إلى صفحة تعديل الطبيب
                window.open('/doctors/' + doctorId + '/edit/', '_blank');
            } else {
                alert('الرجاء اختيار طبيب أولاً');
                return false;
            }
        });

        $('.edit-hospital-btn').click(function() {
            var hospitalId = $('#id_hospital').val();
            if (hospitalId) {
                // الانتقال إلى صفحة تعديل المستشفى
                window.open('/hospitals/' + hospitalId + '/edit/', '_blank');
            } else {
                alert('الرجاء اختيار مستشفى أولاً');
                return false;
            }
        });

        // تفعيل أزرار حفظ البيانات في النوافذ المنبثقة
        $('.save-patient-btn').click(function() {
            // جمع بيانات المريض الجديد
            var patientData = {
                national_id: $('#id_new_patient_national_id').val(),
                name: $('#id_new_patient_name').val(),
                name_en: $('#id_new_patient_name_en').val(),
                phone: $('#id_new_patient_phone').val(),
                nationality: $('#id_new_patient_nationality').val(),
                nationality_en: $('#id_new_patient_nationality_en').val(),
                employer_name: $('#id_new_patient_employer_name').val(),
                employer_name_en: $('#id_new_patient_employer_name_en').val(),
                address: $('#id_new_patient_address').val(),
                address_en: $('#id_new_patient_address_en').val()
            };

            // التحقق من البيانات المطلوبة
            if (!patientData.national_id || !patientData.name) {
                alert('الرجاء إدخال رقم الهوية واسم المريض');
                return;
            }

            // إرسال البيانات إلى الخادم
            $.ajax({
                url: '{% url "core:patient_create_ajax" %}',
                type: 'POST',
                data: patientData,
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    if (response.success) {
                        // إضافة المريض الجديد إلى القائمة المنسدلة
                        var newOption = new Option(response.object_text, response.object_id, true, true);
                        $('#id_patient').append(newOption).trigger('change');

                        // إغلاق النافذة المنبثقة
                        $('#patientModal').modal('hide');

                        // مسح حقول النموذج
                        $('#id_new_patient_national_id, #id_new_patient_name, #id_new_patient_name_en, #id_new_patient_phone, #id_new_patient_nationality, #id_new_patient_nationality_en, #id_new_patient_employer_name, #id_new_patient_employer_name_en, #id_new_patient_address, #id_new_patient_address_en').val('');

                        // عرض رسالة نجاح
                        alert(response.message);
                    } else {
                        alert(response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert('حدث خطأ أثناء إضافة المريض');
                }
            });
        });

        $('.save-doctor-btn').click(function() {
            // جمع بيانات الطبيب الجديد
            var doctorData = {
                national_id: $('#id_new_doctor_national_id').val(),
                name: $('#id_new_doctor_name').val(),
                name_en: $('#id_new_doctor_name_en').val(),
                phone: $('#id_new_doctor_phone').val(),
                position: $('#id_new_doctor_position').val(),
                position_en: $('#id_new_doctor_position_en').val(),
                hospital: $('#id_new_doctor_hospital').val()
            };

            // التحقق من البيانات المطلوبة
            if (!doctorData.name) {
                alert('الرجاء إدخال اسم الطبيب');
                return;
            }

            // إرسال البيانات إلى الخادم
            $.ajax({
                url: '{% url "core:doctor_create_ajax" %}',
                type: 'POST',
                data: doctorData,
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    if (response.success) {
                        // إضافة الطبيب الجديد إلى القائمة المنسدلة
                        var newOption = new Option(response.object_text, response.object_id, true, true);
                        $('#id_doctor').append(newOption).trigger('change');

                        // إغلاق النافذة المنبثقة
                        $('#doctorModal').modal('hide');

                        // مسح حقول النموذج
                        $('#id_new_doctor_national_id, #id_new_doctor_name, #id_new_doctor_name_en, #id_new_doctor_phone, #id_new_doctor_position, #id_new_doctor_position_en, #id_new_doctor_hospital').val('');

                        // عرض رسالة نجاح
                        alert(response.message);
                    } else {
                        alert(response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert('حدث خطأ أثناء إضافة الطبيب');
                }
            });
        });

        $('.save-hospital-btn').click(function() {
            // جمع بيانات المستشفى الجديد
            var hospitalData = {
                name: $('#id_new_hospital_name').val(),
                name_en: $('#id_new_hospital_name_en').val(),
                address: $('#id_new_hospital_address').val(),
                address_en: $('#id_new_hospital_address_en').val(),
                contact_info: $('#id_new_hospital_contact_info').val()
            };

            // التحقق من البيانات المطلوبة
            if (!hospitalData.name) {
                alert('الرجاء إدخال اسم المستشفى');
                return;
            }

            // إرسال البيانات إلى الخادم
            $.ajax({
                url: '{% url "core:hospital_create_ajax" %}',
                type: 'POST',
                data: hospitalData,
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    if (response.success) {
                        // إضافة المستشفى الجديد إلى القائمة المنسدلة
                        var newOption = new Option(response.object_text, response.object_id, true, true);
                        $('#id_new_doctor_hospital').append(newOption).trigger('change');

                        // إغلاق النافذة المنبثقة
                        $('#hospitalModal').modal('hide');

                        // مسح حقول النموذج
                        $('#id_new_hospital_name, #id_new_hospital_name_en, #id_new_hospital_address, #id_new_hospital_address_en').val('');

                        // عرض رسالة نجاح
                        alert(response.message);
                    } else {
                        alert(response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert('حدث خطأ أثناء إضافة المستشفى');
                }
            });
        });
// توليد رقم إجازة تلقائي عند اختيار البادئة
        $('#id_prefix').change(function() {
            var prefix = $(this).val();
            // إرسال طلب AJAX للحصول على رقم إجازة جديد
            $.ajax({
                url: '/api/generate-sick-leave-id/',
                type: 'GET',
                data: {
                    prefix: prefix
                },
                success: function(response) {
                    $('#id_leave_id').val(response.leave_id);
                },
                error: function(xhr, status, error) {
                    console.error('Error generating leave ID:', error);
                    // في حالة الخطأ، نقوم بتوليد رقم محلي مؤقت
                    var today = new Date();
                    var dateString = today.getFullYear().toString() +
                                    (today.getMonth() + 1).toString().padStart(2, '0') +
                                    today.getDate().toString().padStart(2, '0');
                    var randomNum = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
                    $('#id_leave_id').val(prefix + dateString + randomNum);
                }
            });
        });

    });
</script>
<script>
    document.getElementById('id_prefix').addEventListener('change', function() {
        const selectedValue = this.value;
        const targetElement = document.getElementById('id_leave_id');
        
        if (selectedValue && targetElement.value.length >= 3) {
            // استبدال أول 3 أحرف من العنصر الهدف بالقيمة المختارة
            targetElement.value = selectedValue + targetElement.value.substring(3);
        } else if (!selectedValue) {
            // إذا لم يتم اختيار أي شيء، ارجع إلى القيمة الأصلية
            targetElement.value = 'usr_' + targetElement.value.substring(3);
        }
    });
</script>
{% endblock %}
